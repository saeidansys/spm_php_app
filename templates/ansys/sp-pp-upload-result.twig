<!DOCTYPE html>
<html lang="en">
<head>
    <title>Ansys - Service Partner Portal</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/ansys_site.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="DataTables/datatables.min.css"/>
    <link rel="stylesheet" type="text/css" href="DataTables/DataTables-1.11.2/css/dataTables.bootstrap5.min.css"/>
    <link rel="stylesheet" type="text/css" href="DataTables/Buttons-2.0.0/css/buttons.dataTables.min.css"/>
    <link rel="stylesheet" type="text/css" href="DataTables/Select-1.3.3/css/select.dataTables.min.css"/>
    <link rel="stylesheet" type="text/css" href="DataTables/Buttons-2.0.0/css/buttons.bootstrap5.min.css"/>
    <link rel="stylesheet" type="text/css" href="DataTables/SearchPanes-1.4.0/css/searchPanes.bootstrap5.min.css"/>

    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="DataTables/datatables.min.js"></script>

    <style>
        th, td {
            white-space: nowrap;
        }

        td[contenteditable="true"] {
            background-color: #fffbe6;
            border: 1px dashed #ff0000; /* Yellow dashed */
            transition: all 0.3s ease;
            cursor: text;
        }

        td.edited {
            background-color: #e6ffed;
            border: 1px solid #28a745; /* Green solid */
        }
    </style>

</head>
<body style="background-color: #000000;">

<div class="container-fluid mt-5 mb-5 p-3 rounded rounded-3" style="background-color: #ffffff; max-width: 90%;">

    <div class="row">
        <img src="/img/R.png" class="img-fluid"/>
    </div>

    <div class="row">
        <h1>Service Partner Portal - {{ spname }}</h1>
    </div>

    <div class="row">
        <h2>Project Plan Upload Results</h2>
    </div>

    <h3>General notifications</h3>

    {% if notifications|length > 0 %}
        {% for notification in notifications %}
            <div class="alert alert-{{ notification.severity }} mt-2">{{ notification.message }}</div>
        {% endfor %}
    {% endif %}

    {% if newerrors is empty %}

        <div class="alert alert-success">The file is OK and can be submitted.</div>
        <a href="/submitppffile?c={{ spid64 }}" class="btn btn-primary" onclick="showLoadingScreen(this)">Submit
            file</a>

        <h4>Your data</h4>

        <table class="table table-striped w-100" id="uploadedrows">
            <thead>
            <tr>
                <th>Row In File</th>
                <th>Consumed Update Date</th>
                <th>SP PO N°</th>
                <th>Project ID</th>
                <th>Measurement Reporting Unit ( Hr, Day, Money)</th>
                <th>Baseline</th>
                <th>Consumed</th>
                <th>SP Rate</th>
                <th>SP Currency</th>
                <th>Project Start Month</th>
                <th>Project Start Day</th>
                <th>Project Start Year</th>
                <th>Project End Month</th>
                <th>Project End Day</th>
                <th>Project End Year</th>
                <th>SP Resource Type</th>
                <th>Project Task/WP Name</th>
                <th>Project Activity Name</th>
                <th>Executive Summary</th>
                <th>SP Unique ID</th>
            </tr>
            </thead>
            <tbody>
            {% for uploadedrow in uploadeddata %}
                <tr>
                    <td>{{ uploadedrow.row_in_file }}</td>
                    <td>{{ uploadedrow.consumed_update_date }}</td>
                    <td>{{ uploadedrow.sppon }}</td>
                    <td>{{ uploadedrow.project_id }}</td>
                    <td>{{ uploadedrow.project_type }}</td>
                    <td>{{ uploadedrow.baseline }}</td>
                    <td>{{ uploadedrow.consumed_actual }}</td>
                    <td>{{ uploadedrow.sp_rate }}</td>
                    <td>{{ uploadedrow.sp_currency }}</td>
                    <td>{{ uploadedrow.psd_month }}</td>
                    <td>{{ uploadedrow.psd_day }}</td>
                    <td>{{ uploadedrow.psd_year }}</td>
                    <td>{{ uploadedrow.ped_month }}</td>
                    <td>{{ uploadedrow.ped_day }}</td>
                    <td>{{ uploadedrow.ped_year }}</td>
                    <td>{{ uploadedrow.sp_res_type }}</td>
                    <td>{{ uploadedrow.project_task }}</td>
                    <td>{{ uploadedrow.project_activity_name }}</td>
                    <td>{{ uploadedrow.executive_summary }}</td>
                    <td>{{ uploadedrow.sp_unique_id }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>

        <script>
            let tableuploaded = new DataTable('#uploadedrows', {
                'scrollX': true,
                dom: 'Blfrtip',
                select: false,
                buttons: []
            });
        </script>

    {% else %}

        <h3>Fixable errors</h3>

        <table class="table table-striped w-100" id="errorrows">
            <thead>
            <tr>
                <th>Row In File</th>
                <th>Consumed Update Date</th>
                <th>SP PO N°</th>
                <th>Project ID</th>
                <th>Measurement Reporting Unit ( Hr, Day, Money)</th>
                <th>Baseline</th>
                <th>Consumed</th>
                <th>SP Rate</th>
                <th>SP Currency</th>
                <th>Project Start Month</th>
                <th>Project Start Day</th>
                <th>Project Start Year</th>
                <th>Project End Month</th>
                <th>Project End Day</th>
                <th>Project End Year</th>
                <th>SP Resource Type</th>
                <th>Project Task/WP Name</th>
                <th>Project Activity Name</th>
                <th>Executive Summary</th>
                <th>SP Unique ID</th>
            </tr>
            </thead>
            <tbody>
            {% for fileRowNumber, errorrow in newerrors %}
                <tr>
                    <td>{{ fileRowNumber }}</td>
                    <td {% if 'consumed_update_date' in errorrow.column %}contenteditable="true"{% endif %}>{% if 'consumed_update_date' in errorrow.column %}YYYY-MM-DD{% else %}{{ errorrow.row.consumed_update_date }}{% endif %}</td>
                    <td {% if 'sppon' in errorrow.column %}contenteditable="true"{% endif %}>{{ errorrow.row.sppon }}</td>
                    <td {% if 'project_id' in errorrow.column %}contenteditable="true"{% endif %}>{{ errorrow.row.project_id }}</td>
                    <td {% if 'project_type' in errorrow.column %}contenteditable="true"{% endif %}>{{ errorrow.row.project_type }}</td>
                    <td {% if 'baseline' in errorrow.column %}contenteditable="true"{% endif %}>{{ errorrow.row.baseline }}</td>
                    <td {% if 'consumed_actual' in errorrow.column %}contenteditable="true"{% endif %}>{{ errorrow.row.consumed_actual }}</td>
                    <td {% if 'sp_rate' in errorrow.column %}contenteditable="true"{% endif %}>{{ errorrow.row.sp_rate }}</td>
                    <td {% if 'sp_currency' in errorrow.column %}contenteditable="true"{% endif %}>{{ errorrow.row.sp_currency }}</td>
                    <td {% if 'project_start' in errorrow.column %}contenteditable="true"{% endif %}>{{ errorrow.row.psd_month }}</td>
                    <td {% if 'project_start' in errorrow.column %}contenteditable="true"{% endif %}>{{ errorrow.row.psd_day }}</td>
                    <td {% if 'project_start' in errorrow.column %}contenteditable="true"{% endif %}>{{ errorrow.row.psd_year }}</td>
                    <td {% if 'project_end' in errorrow.column %}contenteditable="true"{% endif %}>{{ errorrow.row.ped_month }}</td>
                    <td {% if 'project_end' in errorrow.column %}contenteditable="true"{% endif %}>{{ errorrow.row.ped_day }}</td>
                    <td {% if 'project_end' in errorrow.column %}contenteditable="true"{% endif %}>{{ errorrow.row.ped_year }}</td>
                    <td {% if 'sp_res_type' in errorrow.column %}contenteditable="true"{% endif %}>{{ errorrow.row.sp_res_type }}</td>
                    <td {% if 'project_task' in errorrow.column %}contenteditable="true"{% endif %}>{{ errorrow.row.project_task }}</td>
                    <td {% if 'project_activity_name' in errorrow.column %}contenteditable="true"{% endif %}>{{ errorrow.row.project_activity_name }}</td>
                    <td {% if 'executive_summary' in errorrow.column %}contenteditable="true"{% endif %}>{{ errorrow.row.executive_summary }}</td>
                    <td {% if 'sp_unique_id' in errorrow.column %}contenteditable="true"{% endif %}>{{ errorrow.row.sp_unique_id }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>

        <button id="submitEdits" class="btn btn-primary" onclick="showLoadingScreen(this)">Submit Changes</button>
        <a href="/spbppuploadform?c={{ spid64 }}" class="btn btn-secondary">Re-upload file</a>

        <script>
            document.getElementById('submitEdits').addEventListener('click', function () {
                const table = document.getElementById('errorrows');
                const data = [];
                for (let i = 1; i < table.rows.length; i++) {
                    const row = table.rows[i];
                    const rowInFile = row.cells[0].textContent.trim();
                    const consumedUpdateDate = row.cells[1].textContent.trim();
                    const spPoN = row.cells[2].textContent.trim();
                    const projectId = row.cells[3].textContent.trim();
                    const projectType = row.cells[4].textContent.trim();
                    const baseline = row.cells[5].textContent.trim();
                    const consumed = row.cells[6].textContent.trim();
                    const spRate = row.cells[7].textContent.trim();
                    const spCurrency = row.cells[8].textContent.trim();
                    const pStartMonth = row.cells[9].textContent.trim();
                    const pStartDay = row.cells[10].textContent.trim();
                    const pStartYear = row.cells[11].textContent.trim();
                    const pEndMonth = row.cells[12].textContent.trim();
                    const pEndDay = row.cells[13].textContent.trim();
                    const pEndYear = row.cells[14].textContent.trim();
                    const spResourceType = row.cells[15].textContent.trim();
                    const projectTask = row.cells[16].textContent.trim();
                    const projectActivity = row.cells[17].textContent.trim();
                    const executiveSummary = row.cells[18].textContent.trim();
                    const spUniqueId = row.cells[19].textContent.trim();
                    data.push({
                        rowInFile,
                        consumedUpdateDate,
                        spPoN,
                        projectId,
                        projectType,
                        baseline
                        ,
                        consumed,
                        spRate,
                        spCurrency,
                        pStartMonth,
                        pStartDay,
                        pStartYear,
                        pEndMonth,
                        pEndDay,
                        pEndYear,
                        spResourceType,
                        projectTask,
                        projectActivity,
                        executiveSummary,
                        spUniqueId
                    });
                }
                // console.log('Edited Data:', data);
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/spsubmitedits';
                form.style.display = 'none';

                const dataInput = document.createElement('input');
                dataInput.type = 'hidden';
                dataInput.name = 'editedData';
                dataInput.value = JSON.stringify(data);
                form.appendChild(dataInput);

                document.body.appendChild(form);
                form.submit();
            });

            let table = new DataTable('#errorrows', {
                'scrollX': true,
                dom: 'Blfrtip',
                select: false,
                buttons: [],
                paging: false
            });

            document.querySelectorAll('#errorrows td[contenteditable="true"]').forEach(cell => {
                const originalValue = cell.textContent.trim();

                // Track original value
                cell.dataset.originalValue = originalValue;

                cell.addEventListener('blur', () => {
                    const newValue = cell.textContent.trim();
                    if (newValue !== cell.dataset.originalValue) {
                        cell.classList.add('edited');
                    } else {
                        cell.classList.remove('edited');
                    }
                });

                cell.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        cell.blur();
                    }
                });

                cell.addEventListener('paste', (e) => {
                    e.preventDefault();

                    const text = (e.clipboardData || window.clipboardData).getData('text/plain');

                    // Insert plain text at caret
                    document.execCommand('insertText', false, text);
                });

            });

            function attachDatePicker(cell) {
                const currentText = cell.textContent.trim();
                const input = document.createElement('input');
                input.type = 'date';
                input.classList.add('form-control');
                input.style.minWidth = '150px';
                input.value = /^\d{4}-\d{2}-\d{2}$/.test(currentText) ? currentText : '';

                input.addEventListener('blur', () => {
                    if (input.value) {
                        const formattedDate = input.value;
                        cell.textContent = formattedDate;
                        if (formattedDate !== cell.dataset.originalValue) {
                            cell.classList.add('edited');
                        } else {
                            cell.classList.remove('edited');
                        }
                    } else {
                        cell.textContent = cell.dataset.originalValue;
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        input.blur();
                    }
                });

                cell.innerHTML = '';
                cell.appendChild(input);
                input.focus();
            }

            document.querySelectorAll('#errorrows td[contenteditable="true"]').forEach(cell => {
                const isConsumedDate = cell.cellIndex === 1;

                const originalValue = cell.textContent.trim();
                cell.dataset.originalValue = originalValue;

                cell.addEventListener('click', () => {
                    if (isConsumedDate && !cell.querySelector('input')) {
                        attachDatePicker(cell);
                    }
                });
            });
        </script>


    {% endif %}

</div>

<div id="loading-overlay">
    <div id="loader-container" class="d-flex justify-content-center">
        <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status"
             onclick="showLoadingScreen(this)"></div>
    </div>
</div>

<script>

    function showLoadingScreen(eventsender) {
        document.getElementById('loading-overlay').style.display = "block";
    }

    window.onunload = function () {
        document.getElementById('loading-overlay').style.display = "none";
    }

</script>

</body>
</html>
